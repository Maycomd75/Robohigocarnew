<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hiago Car - Assistente Virtual</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: Arial; background: #1e1e1e; margin: 0; height: 100vh; display: flex; flex-direction: column; }
  header { background: #2ecc71; color: #000; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; border-bottom: 2px solid #000; }
  #chat { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
  .bot, .user { max-width: 75%; padding: 12px; border-radius: 12px; animation: fadeIn 0.3s ease; white-space: pre-line; }
  .bot { background: #2ecc71; color: #fff; align-self: flex-start; }
  .user { background: #007bff; color: white; align-self: flex-end; }
  #input-area { display: flex; padding: 10px; background: #2c2c2c; border-top: 2px solid #fff; }
  #input { flex: 1; padding: 10px; border: none; border-radius: 8px; outline: none; font-size: 14px; }
  button { margin-left: 10px; background: #2ecc71; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
  button:hover { background: #2ecc71; }
  .option-btn { display: block; margin: 5px 0; padding: 8px; border-radius: 8px; background: #2ecc71; color: #fff; border: none; cursor: pointer; width: fit-content; }
  .option-btn:hover { background: #2ecc71; }
  @keyframes fadeIn { from {opacity: 0; transform: translateY(5px);} to {opacity: 1; transform: translateY(0);} }
</style>
</head>
<body>
<header>‚öôÔ∏è Hiago Car - Assistente Virtual</header>
<div id="chat"></div>
<div id="input-area">
  <input type="text" id="input" placeholder="Digite sua mensagem..." />
  <button onclick="sendMessage()">Enviar</button>
</div>

<script>
const { jsPDF } = window.jspdf;
const chat = document.getElementById("chat");
const input = document.getElementById("input");

let step = "welcome";
let cliente = { nome: "", placa: "", modelo: "", servicos: [], data: "", hora: "" };

const servicos = {
  "1": { nome: "Alinhamento", valor: 80 },
  "2": { nome: "Balanceamento", valor: 70 },
  "3": { nome: "Troca de √ìleo", valor: 150 },
  "4": { nome: "Troca de Filtros", valor: 90 },
  "5": { nome: "Suspens√£o", valor: 200 }
};

// === API DO GOOGLE SHEETS (substitua pelo SEU URL do Web App) ===
const API_URL = "https://script.google.com/macros/s/AKfycbwZNOoo_-1lPNCCWihaZmczGS-_TmrgeSzxDDxCygkZqXniVO421Itvta2z51OKb2fg/exec";

function salvarNoSheets(cliente) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "salvar",
      nome: cliente.nome,
      placa: cliente.placa,
      modelo: cliente.modelo,
      data: cliente.data,
      hora: cliente.hora,
      servicos: cliente.servicos.map(s => s.nome || s).join(", ")
    }),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => console.log("‚úÖ Dados enviados para Google Sheets"))
  .catch(err => console.error("‚ùå Erro ao enviar:", err));
}

function addMessage(text, sender) {
  const msg = document.createElement("div");
  msg.className = sender;
  msg.textContent = text;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
}

function botTyping(text, delay = 800) {
  addMessage("Digitando...", "bot");
  setTimeout(() => { chat.lastChild.remove(); addMessage(text, "bot"); }, delay);
}

function startChat() {
  cliente = { nome: "", placa: "", modelo: "", servicos: [], data: "", hora: "" };
  botTyping("ü§ñ Ol√°, seja bem-vindo(a) √† Hiago Car! üöó‚öôÔ∏è");
  setTimeout(() => botTyping("Sou seu assistente virtual e vou te ajudar a resolver tudo de forma r√°pida e pr√°tica."), 1000);
  setTimeout(() => {
    botTyping(
      "Como posso te ajudar hoje?\n\n" +
      "1Ô∏è‚É£ Solicitar Or√ßamento üßæ\n" +
      "2Ô∏è‚É£ Agendar Servi√ßo üìÖ\n" +
      "3Ô∏è‚É£ Conhecer nossos Servi√ßos üõ†Ô∏è\n" +
      "4Ô∏è‚É£ Falar com um Atendente üìû\n\n" +
      "üëâ A qualquer momento digite 'voltar' para voltar ao in√≠cio."
    );
    step = "voltar";
  }, 2000);
}

function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  addMessage(text, "user");
  input.value = "";
  handleFlow(text);
}

function handleFlow(text) {
  if (text.toLowerCase() === "voltar") {
    botTyping("üîô Voltando ao menu principal...");
    setTimeout(() => startChat(), 1000);
    return;
  }

  switch(step) {
    case "voltar":
      if (text === "1") { botTyping("√ìtimo! Vamos fazer seu or√ßamento.\nQual seu nome?"); step = "nome"; }
      else if (text === "2") { botTyping("Para agendar um hor√°rio, informe seu nome:"); step = "nomeAgendamento"; }
      else if (text === "3") { botTyping("üìã Lista de Servi√ßos:\n\n" + Object.keys(servicos).map(k => `${k}Ô∏è‚É£ ${servicos[k].nome} - R$ ${servicos[k].valor}`).join("\n")); step = "menu"; }
      else if (text === "4") {
        botTyping("Conectando voc√™ a um atendente...");
        setTimeout(() => {
          const btn = document.createElement("button");
          btn.textContent = "üí¨ Abrir WhatsApp";
          btn.className = "option-btn";
          btn.onclick = () => {
            const numero = '5563992007030';
            const mensagem = "üìû Ol√°! Gostaria de falar com um atendente da Hiago Car.";
            const link = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
            window.open(link, '_blank');
          };
          chat.appendChild(btn);
          chat.scrollTop = chat.scrollHeight;
        }, 1000);
        step = "end";
      }
      else { botTyping("Por favor, escolha uma op√ß√£o v√°lida (1-4)."); }
      break;

    // OR√áAMENTO
    case "nome":
      cliente.nome = text;
      botTyping(`Prazer, ${cliente.nome}! Informe a placa do ve√≠culo:`);
      step = "placa";
      break;
    case "placa":
      cliente.placa = text;
      botTyping("Qual o modelo do ve√≠culo?");
      step = "modelo";
      break;
    case "modelo":
      cliente.modelo = text;
      botTyping(
        "Quais servi√ßos deseja realizar?\nDigite os n√∫meros separados por v√≠rgula:\n" +
        Object.keys(servicos).map(k => `${k}Ô∏è‚É£ ${servicos[k].nome} - R$ ${servicos[k].valor}`).join("\n") +
        "\nüëâ Exemplo: 1,3,5"
      );
      step = "servico";
      break;
    case "servico":
      const escolhas = text.split(",").map(s => s.trim());
      cliente.servicos = [];
      let total = 0;
      escolhas.forEach(num => { if (servicos[num]) { cliente.servicos.push(servicos[num]); total += servicos[num].valor; } });
      if (cliente.servicos.length > 0) {
        botTyping(`‚úÖ Or√ßamento gerado:\n\nüë§ Cliente: ${cliente.nome}\nüöò Placa: ${cliente.placa}\nüìç Modelo: ${cliente.modelo}\n\nüîß Servi√ßos escolhidos:\n${cliente.servicos.map(s => `- ${s.nome} (R$ ${s.valor},00)`).join("\n")}\n\nüí∞ Total: R$ ${total},00\n\nClique abaixo para baixar o PDF.`);
        setTimeout(() => { const btn = document.createElement("button"); btn.textContent = "üìÑ Baixar Or√ßamento"; btn.onclick = gerarPDF; chat.appendChild(btn); chat.scrollTop = chat.scrollHeight; }, 1500);
        step = "end";
      } else { botTyping("Escolha pelo menos um servi√ßo v√°lido (1-5)."); }
      break;

    // AGENDAMENTO
    case "nomeAgendamento":
      cliente.nome = text;
      botTyping("Informe a placa do ve√≠culo:");
      step = "placaAgendamento";
      break;
    case "placaAgendamento":
      cliente.placa = text;
      botTyping("Qual o modelo do ve√≠culo?");
      step = "modeloAgendamento";
      break;
    case "modeloAgendamento":
      cliente.modelo = text;
      carregarDisponiveis();
      break;
  }
}

/* ==========================
   AGENDAMENTO - NOVA ABORDAGEM
========================== */
function carregarDisponiveis() {
  fetch(API_URL) // retorna JSON com todos os hor√°rios livres [{data:"01/10/2025", hora:"08:00"}, ...]
    .then(res => res.json())
    .then(lista => {
      const agrupados = {};
      lista.forEach(item => {
        if (!agrupados[item.data]) agrupados[item.data] = [];
        agrupados[item.data].push(item.hora);
      });

      botTyping("Escolha uma data dispon√≠vel:");
      setTimeout(() => {
        Object.keys(agrupados).forEach(data => {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.textContent = data;
          btn.onclick = () => {
            addMessage(data, "user");
            cliente.data = data;
            botTyping(`Escolha um hor√°rio dispon√≠vel para ${data}:`);
            agrupados[data].forEach(hora => {
              const btnHora = document.createElement("button");
              btnHora.className = "option-btn";
              btnHora.textContent = hora;
              btnHora.onclick = () => {
                addMessage(hora, "user");
                cliente.hora = hora;
                botTyping(`‚úÖ Agendamento conclu√≠do!\nNome: ${cliente.nome}\nPlaca: ${cliente.placa}\nModelo: ${cliente.modelo}\nData: ${cliente.data}\nHor√°rio: ${cliente.hora}`);
                salvarNoSheets(cliente);
                step = "end";
              };
              chat.appendChild(btnHora);
            });
          };
          chat.appendChild(btn);
        });
      }, 500);
      step = "horaAgendamento";
    })
    .catch(err => botTyping("‚ùå N√£o foi poss√≠vel carregar os hor√°rios. Tente novamente mais tarde."));
}

/* ==========================
   PDF (sem mudan√ßas)
========================== */
function gerarPDF() {
  const doc = new jsPDF();
  doc.setFillColor(30, 80, 180);
  doc.rect(0, 0, 210, 25, "F");
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(16);
  doc.text("Hiago Car - Or√ßamento de Servi√ßos", 105, 16, { align: "center" });
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(12);
  doc.text(`Cliente: ${cliente.nome}`, 14, 40);
  doc.text(`Placa: ${cliente.placa}`, 14, 48);
  doc.text(`Modelo: ${cliente.modelo}`, 14, 56);
  doc.text(`Telefone: (63) 99264-5216`, 14, 64);
  let startY = 80;
  doc.setFillColor(0, 0, 0);
  doc.setTextColor(255, 255, 255);
  doc.rect(14, startY, 182, 10, "F");
  doc.text("Servi√ßo", 20, startY + 7);
  doc.text("Valor (R$)", 190, startY + 7, { align: "right" });
  let y = startY + 15;
  let total = 0;
  cliente.servicos.forEach((s, i) => {
    if (i % 2 === 0) {
      doc.setFillColor(245, 245, 245);
      doc.rect(14, y - 6, 182, 10, "F");
    }
    doc.setTextColor(0, 0, 0);
    doc.text(s.nome, 20, y);
    doc.text(s.valor.toFixed(2), 190, y, { align: "right" });
    total += s.valor;
    y += 10;
  });
  y += 5;
  doc.setFillColor(30, 80, 180);
  doc.rect(14, y - 6, 182, 10, "F");
  doc.setTextColor(255, 255, 255);
  doc.text(`TOTAL: R$ ${total.toFixed(2)}`, 190, y, { align: "right" });
  doc.setFontSize(10);
  doc.setTextColor(100);
  doc.text("Obrigado por escolher a Hiago Car", 105, 290, { align: "center" });
  doc.save(`Orcamento_${cliente.nome}.pdf`);
}

startChat();
</script>
</body>
</html>
